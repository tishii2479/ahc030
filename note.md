# 考察メモ

- 良い解が出る方針を探す

# 2/9

- **実行時間制限: 3sec**
- 再挑戦できることは使うのか？
    - コスト1大きすぎるか
    - 候補が絞れてきたら、もしかしたら挑戦した方が期待コストが低いかも
- 何回も同じところを検査するのは？
- 上限はN^2
- 情報理論の復号方法が参考になりそう
- 連結なのは使えるはず
- エラー率ごとのチューニングは必要
- v>1の時の影響は？
    - 複数マスがあるように見える
    - 結局最終的には正確にvが推定できている
    - ほんとか？要検討
    - 大きいマスを見つけると、複数重なっていることがわかる
- Sの大きさはどうすれば良い？
- エラーが0の時は？
- 連結という制約がない場合は？
- 01整数計画問題として定式化できないか？
- 最上位になるには尤度を考える必要はありそうだが、、
    - エラー率ごとのパラメータチューニングでなんとかなるか？20通りだし
- 形の情報は超重要
    - 最終的には配置がどうなっているかを元に推定できるはず
    - 一番可能性が高い配置を探すには？
- 配置を固定するとか？
    - 候補が複数あるなら、一番不確かさなところを調べれば良い
    - ただ、一マスだけは調べられない、、
- コストは`1/sqrt(k)`
- 「集合Sを調べる」は言い換えができないか？
    - k個のマスを調べたいなら、kxkのrankがkの行列を作れば良い
        - 1個の1ベクトルと、k-1個の1個だけ欠けているベクトルを作れば良い
        - エラーが面倒なら、k個の1個だけ欠けているベクトルでもそんなに変わらなそう
        - 自由度がkなので、これが最善そう
    - この時、スコアは`(k-1)/sqrt(k)`

$$
x \sim N \left( v(S) (1 - 2\epsilon) + k\epsilon, k\epsilon(1 - \epsilon) \right) \\
x' = \frac{x - k\epsilon}{1 - 2\epsilon} \\
x' \sim N \left( v(S), \frac{k\epsilon(1 - \epsilon)}{(1 - 2\epsilon)^2} \right)
$$

- ミノを考慮して調べるのが筋が良さそう
    - 全パターンは一様ランダムなので、尤度を調べられる？
    - max(M)=20なので無理そうだけど、近いことはできそう
    - Mの分布めっちゃ小さい
        - 平均ほぼ6、中央値も6
    - 左上のマスの位置がわかれば復元できる
- 入力ケースの観察
    - 何箇所かにかなり集中している
    - 油田の個数は多くない
- N^2/5 ~ N^2/2が埋まる
    - 最大でも半分くらいしか埋まらない
- kはどれくらいにするのかな
- なんか動かさないと肌感が掴めないな

- まずはシンプルな解法を考える
- 上限がN^2なので、直接掘るがないと厳しいな
- 集合と見ると、積や和などの演算ができる？
- 油田がある場所に当たりをつける -> 具体的に探す
- 特徴的な形状（横に4連続とか）を探す
    - ミノを動かして探す

# 2/10

- 失敗回数を0にしながら、コストを下げる必要がある

- 窓を動かして期待値を求める
    - ミノを動かす方が良い？
    - 調べたところは期待値を管理しておく
    - 望みが低いところは調べない？
        - 微改善
- 情報を集めてから、ミノの位置を決定する最適化問題を解く？
    - 自由度はO(M^N^2)
    - 解いたあとで間違っていたら？

- 情報の集め方

1. kxkのマスを動かして、x[i][j]に期待コストを加算していく、c[i][j] += 1する
2. x[i][j] / c[i][j]する
3. 周りを考慮して、x[i][j]を再計算する
    - どうやって？

- 確率が高いところから順に決めるでも十分良いスコアが出そう
    - 不正解になる確率が非常に高いが、、
- 形を工夫（ミノの形状）にすれば、誤検出は小さくなりそう
    - 完全一致が強い

- 不正解な場合はどうする？
    - 複数あり得る解を作って、分散が大きいところを調べる
    - ミノを考慮せずにvを作って、一致しないところを調べる
- x[i][j]の再計算
    - 01整数計画問題として解けそう
    - 線形緩和して良さそう
- 現状のx[i][j]の問題点
    - 値が大きいところ重視してしまう
    - 周囲にある油田の数に影響される
- ミノに当てはめるように候補を決めるか、理想的な場所を探すか
- 正方形だけだと多分だめ

- 工夫ポイント
    - 窓の形
        - ミノによくある形にした方が良さそう
        - 飛び飛びにしたらどうなる？
            - ほぼ一様になる
            - 自分が0か1かは、誤差になってしまう

- 方向性
    - 山登りの改善
    - 追加情報の取得
    - 最初の情報の取得方法
        - 逐次的にするか、など
- 勝手に段階に分けているが、これに固執しない方が良い
    - ミノの位置は特定する必要があるのか？
    - 流石にありそう
- とりあえず全ケースACを目指す

- 自由度がある場所が偏ってしまっている
    - 隣接しているところや、くの字になっているところとか
    - 安定していないところを調べるとか？
- 調べる必要ないところ（ほぼ0のところ）は調べない
    - 最初の調査でも、追加調査でも

- なぜ間違えているか
    - 誤差が大きくて誤って認識している
    - 最適化結果が正しくない
        - 誤差
        - 自由度
    - 誤差に対する対処
        - kの調整
    - 自由度に対する対処
        - Sの形状を変える
        - 縦横一直線とか？
        - 同じ制約になるべく登場しない方が良い
        - ランダムがいいんじゃないか
- 最適化の改善点
    - 明らかに孤立しているところは0に固定する
- 追加調査
    - 怪しいところから複数選ぶことを何回か繰り返す
    - 形状を変える
    - 境界を間違えがち

- 評価項目
    - 分布最適化の誤差（x_error）
        - 推定値がどれくらい外れているか
        - ||ans - x||_2
    - ミノの配置最適化の誤差（optimize_mino_pos_error）
        - 推定値がどれくらい外れているか + ミノに関する最適化
        - ||v - x||_2
    - 真の解からのズレ（error_count）
        - |v != ans|

- TODO:
    - investigateからxを消す

- 確定が欲しいか？
- 追加調査すべき箇所
    - 分散が大きいところ
        - 「ミノの数とxの値の差が大きいところ」になる？
        - |ミノを考慮した最適化 - xを直接最適化|
    - 自由度が大きいところ
        - 自由度が小さくなるように最初に調査したい
        - ばらけた方が強いか
    - 境界
- ランダム強いか、、

- 正規分布なので、尤度最大化できそう？
    - 対数尤度にするので、どれくらい良いかはわからん
    - kの大きさを変えた時にも近似的に計算できそう

- TODO
    - 山登りの改善
        - 近傍の改善
    - 追加情報の取得の工夫
    - 最初の情報の取得方法

- 追加情報取得の工夫
- きついケースの対策
    - 確定が欲しそう

# 2/11

- 情報取得の工夫
    - 最初は一箇所に固めて調査する
    - ミノがある箇所の周辺
        - 不確かなところを調査したい
        - 直前のミノの位置だけでなく、過去履歴も使用したい
    - ミノの形で調査する
    - 特殊な形（一直線など）で調査
- 制約式だけだと、地理的な条件を考慮していない
- 最初の調査は区別した方が良さそう
- 山登り高速化
    - 今の段階でどれくらいやるべきか
    - 方針が変わらないならやって良さそう
        - 絶対使いそうだし

- 愚直な計算量
    - O(QK + M)
- 差分計算の時間
    - O(|Q_i|*|M_i|)

- きついケース対策
    - 途中で答える間隔を減らして、20手くらい残して最後まで情報を収集する
    - 複数の解の候補を作る
        - 低温で焼きながら、良い解がでてきたら答えてみる
        - 多点スタート
    - 確定を使う
    - きついケースかどうか
        - 適当なロジスティック回帰で判定できそう
    - 2s経過したら、特殊モードに入るとか
    - k、step_sizeのスケジュール関数を作る

- 最適化の工夫
    - 制約式の数は減らせないか、、？
    - 最急降下に近いことはできないか？
    - そもそも山登り以外で解けないか？
    - 近傍足りていないのでは？
        - 隣にずらす、強そう

### TODO:

1. 最適化の改善
    - 必要なイテレーション数を減らしたい
    - 近傍の追加・工夫
        - どういう組でswapが起きているか
    - 初期解の工夫
2. （必要なら）きついケースの対策
    - 解を求めるときの工夫
    - 特殊ルールの追加は最後にしたい
3. 情報取得の工夫
    - ちゃんとばらつきを考慮できないか？
    - 途中
        - 境界だけにする
        - 割合を変化させて精度を見る
    - 最初
        - 工夫する余地ありそうだが、、
4. パラメータ調整

- 差分を意識して2つを動かす
    - 並行移動、2、3点swap
    - 重なりが大きくなるように、少しずれているのでは？
- どこかまで調査して、そこから最適化を続けるのが最適っぽい
    - ばらつきが評価できれば、期待値が計算できる？
        - 相当むずそう
    - 定期的に最適化するのはそこまで悪くないか、、
- 連続で最適化する場合は、多点山登りかre-annealingを試す
    - 解の重複チェックはする
    - 単純なkickでも良さそう

### 考察

- 最適化しながら情報を収集する方向性はあるのか
- kは可変にした方が良いのか
    - 確定は使った方が良いのか？
- どこかまで調査して、そこから最適化を続けるのが最適なのでは？
- 2*N^2まで使い切らない方が良いのでは？

# 2/12

- 近傍
    - action_slide_one
    - action_slide_two
    - action_move_one
    - action_swap_two
    - action_swap_three
- 改善点
    - 複数候補を試す
    - 重複が大きくなるようにswapする
        - そのような位置関係を記録しておく
    - 大きさが似たミノをswapする
        - 実際どうか確認する
    - 3点swap
        - 大きい1つと小さい2つをswap

- きついケースは試行回数が大事っぽい
    - m>10なら、特殊処理で良いかも
- iteration数が十分なら、action-swap-threeは入れた方が良い

- 山登りの質を上げれば、スコアが上がることはわかっている
    - 近傍の網羅性
    - 有効な近傍の割合
    - 高速化
- 情報量は十分
    - 改善する余地はある

- 情報量の改善
    - vの分散の大きさに比例させる
    - p ~ V(v_tij)

- セーフティの処理は必要そう、、
- セーフティ処理案
    1. query_countが制限の3/4を超えたら、焼きなまし
    2. いくつか確定する
